<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="keywords" content="聊天室,休闲,聆听">
    <!--<link type="text/css" rel="stylesheet" href="../css/style.css">-->
    <script src="../../js/jquery/2.0.0/jquery.min.js" type="text/javascript"></script>
    <title>Chat Room</title>
    <style type="text/css">
        .container {
            font-family: "Courier New", serif;
            width: 680px;
            height: 300px;
            overflow: auto;
            border: 1px solid black;
        }

        .LockOff {
            display: none;
            visibility: hidden;
        }

        .LockOn {
            display: block;
            visibility: visible;
            position: absolute;
            z-index: 999;
            top: 0px;
            left: 0px;
            width: 1024%;
            height: 768%;
            background-color: #ccc;
            text-align: center;
            padding-top: 20%;
            filter: alpha(opacity=75);
            opacity: 0.75;
        }
    </style>
    <script type="text/javascript">
        var ws;
        var SocketCreated = false;
        var isUserloggedout = false;
        var name = "";
        function lockOn(str) {
            var lock = $("#skm_LockPane");
            if (lock){
                lock.className = 'LockOn';
            }
            lock.innerHTML = str;
        }

        function lockOff() {
            var lock = $("#skm_LockPane");
            lock.className = 'LockOff';
        }

        function ToggleConnectionClicked() {
            if (SocketCreated && (ws.readyState == 0 || ws.readyState == 1)) {
                lockOn("离开聊天室");
                SocketCreated = false;
                isUserloggedout = true;
                ws.close();
            } else {
                lockOn("进入聊天室");
                Log("准备连接到聊天室");
                try {
                    if ("WebSocket" in window) {
                        ws=new WebSocket("ws://"+ location.host + ":8888/");
                    }
                    else if ("MozWebSocket" in window) {
                        ws = new MozWebSocket("ws://"+ location.host + ":8888/");
                    }

                    SocketCreated = true;
                    isUserloggedout = false;
                } catch (ex) {
                    Log(ex, "ERROR");
                    return;
                }
                $("#ToggleConnection").html("断开");
                ws.onopen = WSonOpen;
                ws.onmessage = WSonMessage;
                ws.onclose = WSonClose;
                ws.onerror = WSonError;
            }
        }


        function WSonOpen() {
            lockOff();
            Log("连接已经建立", "OK");
            $("#SendDataContainer").show();
            ws.send(name);
        }


        function WSonMessage(event) {
            Log(event.data);
        }

        function WSonClose() {
            lockOff();
            if (isUserloggedout) {
                Log("[" + name + "]离开了聊天室");
                $('#ToggleConnection').html("连接");
                $('#SendDataContainer').hide();
            }


        }
        function WSonError() {
            lockOff();
            Log("远程连接中断", "ERROR");
        }

        function SendDataClicked() {
            var data = $("#DataToSend").val().trim();
            if (data != "") {
                ws.send(name + ":\"" + data + "\"");
                document.getElementById("DataToSend").value = "";
            }
        }

        function Log(Text, MessageType) {
            if (MessageType == "OK") Text = "<span style='color: green;'>" + Text + "</span>";
            if (MessageType == "ERROR") Text = "<span style='color: red;'>" + Text + "</span>";
            document.getElementById("LogContainer").innerHTML = document.getElementById("LogContainer").innerHTML + Text + "<br />";
            var LogContainer = document.getElementById('LogContainer');
            LogContainer.scrollTop = LogContainer.scrollHeight;
        }

        (function () {
                    $.ajax({
                        url: "/username",
                        success: function (result) {
                            if (result) {
                                $("#txtName").html(result);
                                name = result;

                            } else {
                                alert("请先登录撒~(๑°ㅁ°๑)‼");
                                top.location = '/html/login.html';
                            }

                        }

                    });
                }()
        );
        $(document).ready(function () {
            $("#SendDataContainer").hide();
            var WebSocketsExist = true;
            try {
                var dummy = new WebSocket("ws://" + location.host + ":8888/");
            } catch (ex) {
                try {
                    webSocket = new MozWebSocket("ws://" + location.host + ":8888/");
                }
                catch (ex) {
                    WebSocketsExist = false;
                }
            }

            if (WebSocketsExist) {
                Log("您的浏览器支持WebSocket<(￣ˇ￣)/，尝试连接到聊天服务器吧~", "OK");
            } else {
                Log("您的浏览器不支持WebSocket(。・＿・。)ﾉ，选择其他的浏览器再尝试连接服务器嗟~", "ERROR");
                document.getElementById("ToggleConnection").disabled = true;
            }
            $("#DataToSend").keypress(function (evt) {
                if (evt.keyCode == 13) {
                    $("#SendData").click();
                    evt.preventDefault();
                }
            })
        });

    </script>
</head>
<body>
<div id="skm_LockPane" class="LockOff"></div>
<form id="form1">
    <h1>Chat Room</h1>
    <br/>
    用户名：<label for="txtName"></label><span id="txtName" class="txtName"></span><br><hr>
    <button id='ToggleConnection' type="button" onclick='ToggleConnectionClicked();'>连接</button>
    <a href="/signOut">
        <button type="button">退出</button>
    </a>
    <br/>
    <br/>
    <div id='LogContainer' class='container'></div>
    <br/>
    <div id='SendDataContainer'>
        <input type="text" id="DataToSend" class="DataToSend" size="88"/>
        <button id='SendData' type="button" onclick='SendDataClicked();'>发送</button>
    </div>
    <br/>
</form>

<div style="display: none">
    <audio controls="controls" autoplay="autoplay">
        <source src="../../audio/LET%20IT%20OUT.mp3">
        <source src="../../audio/I%20Am%20Not%20Alone.mp3">

    </audio>
</div>

</body>
</html>

